<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöö –°–∏—Å—Ç–µ–º–∞ –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è –†–µ–π—Å–∞–º–∏</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        
        .login-page { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .login-box { background: white; border-radius: 20px; padding: 40px; max-width: 400px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .login-title { text-align: center; font-size: 2em; color: #2c3e50; margin-bottom: 30px; }
        .login-icon { text-align: center; font-size: 4em; margin-bottom: 20px; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; }
        .input-group input { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; }
        .input-group input:focus { outline: none; border-color: #667eea; }
        .btn-login { width: 100%; padding: 15px; background: #667eea; color: white; border: none; border-radius: 10px; font-size: 1.1em; font-weight: 600; cursor: pointer; }
        .btn-login:hover { background: #5568d3; }
        .error-msg { color: #e74c3c; text-align: center; margin-top: 15px; font-weight: 600; }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: white; border-radius: 20px; padding: 20px 30px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .header-left h1 { color: #2c3e50; font-size: 1.8em; margin-bottom: 5px; }
        .header-left p { color: #7f8c8d; }
        .header-right { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .user-email { font-weight: 600; color: #2c3e50; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-size: 0.95em; }
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }
        .btn-logout { background: #e74c3c; color: white; }
        .btn-download { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-delete { background: #c0392b; color: white; padding: 8px 15px; font-size: 0.9em; }
        
        .tabs { background: white; border-radius: 15px; padding: 15px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; gap: 10px; }
        .tab { padding: 12px 30px; border: none; border-radius: 10px; font-weight: 700; font-size: 1em; cursor: pointer; background: #f0f0f0; color: #666; transition: all 0.3s; }
        .tab.active { background: #667eea; color: white; }
        .tab:hover:not(.active) { background: #e0e0e0; }
        
        .upload-section { background: white; border-radius: 20px; padding: 30px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; }
        .upload-area { border: 3px dashed #667eea; border-radius: 15px; padding: 40px; cursor: pointer; transition: all 0.3s ease; background: #f8f9fa; }
        .upload-area:hover { background: #e9ecef; border-color: #764ba2; }
        .upload-icon { font-size: 4em; margin-bottom: 15px; }
        
        .orders-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .order-card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); position: relative; transition: all 0.3s ease; }
        .order-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.25); }
        .order-card-content { cursor: pointer; }
        .order-icon { font-size: 3em; text-align: center; margin-bottom: 10px; }
        .order-title { font-size: 1.1em; font-weight: 700; color: #2c3e50; margin-bottom: 8px; text-align: center; }
        .order-info { color: #7f8c8d; font-size: 0.9em; text-align: center; margin-bottom: 5px; }
        .order-actions { display: flex; justify-content: center; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 2px solid #f0f0f0; }
        
        .database-section { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow-x: auto; }
        .database-table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        .database-table th { background: #4a4a4a; color: white; padding: 12px; text-align: center; font-weight: 700; border: 1px solid #000; }
        .database-table td { padding: 10px; border: 1px solid #000; font-weight: 600; font-size: 13px; position: relative; }
        .database-table tbody tr:hover { background: #f0f0f0; }
        .editable-cell { cursor: pointer; transition: all 0.2s; }
        .editable-cell:hover { background: #fff3cd !important; }
        .cell-input { width: 100%; border: 2px solid #667eea; padding: 8px; font-size: 13px; font-weight: 600; box-sizing: border-box; }
        .cell-input:focus { outline: none; border-color: #764ba2; }
        
        .status-cell { text-align: center; cursor: pointer; font-weight: bold; }
        .status-unpaid { background: #f8d7da; color: #721c24; }
        .status-paid { background: #d4edda; color: #155724; }
        
        .sum-cell { background: #fff3cd; font-weight: bold; color: #856404; text-align: center; }
        .calculated-cell { background: #c8e6c9; font-weight: bold; color: #1b5e20; }
        
        .filters { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .filter-btn { padding: 10px 20px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .filter-btn.active { background: #667eea; color: white; }
        .filter-btn:not(.active) { background: #f0f0f0; color: #666; }
        .filter-btn:hover:not(.active) { background: #e0e0e0; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 15px; padding: 30px; max-width: 98%; width: 100%; max-height: 95vh; overflow: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.4); }
        .modal-close { position: fixed; top: 30px; right: 30px; font-size: 3em; cursor: pointer; color: white; background: #e74c3c; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 1001; }
        .modal-close:hover { transform: rotate(90deg) scale(1.1); }
        .modal-title { font-size: 1.8em; font-weight: 700; color: #2c3e50; margin-bottom: 20px; text-align: center; }
        
        .hidden { display: none !important; }
        
        @media print {
            .header-right, .tabs, .upload-section, .filters, .btn, .modal-close, .order-actions { display: none !important; }
            .order-card { break-inside: avoid; }
            .database-table { font-size: 10px; }
            body { background: white; }
            .container { padding: 10px; }
        }
        
        @media (max-width: 768px) {
            .header { flex-direction: column; text-align: center; }
            .tabs { flex-direction: column; }
            .orders-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="loginPage" class="login-page">
        <div class="login-box">
            <div class="login-icon">üîê</div>
            <div class="login-title">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</div>
            <div class="input-group">
                <label>Email</label>
                <input type="email" id="loginEmail" placeholder="example@gmail.com">
            </div>
            <div class="input-group">
                <label>–ü–∞—Ä–æ–ª—å</label>
                <input type="password" id="loginPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
            </div>
            <button class="btn-login" onclick="login()">–í–æ–π—Ç–∏</button>
            <div id="loginError" class="error-msg"></div>
        </div>
    </div>

    <div id="mainPage" class="hidden">
        <div class="container">
            <div class="header">
                <div class="header-left">
                    <h1>üöö –°–∏—Å—Ç–µ–º–∞ –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è –†–µ–π—Å–∞–º–∏</h1>
                    <p>–ó–∞–≥—Ä—É–∂–∞–π—Ç–µ Excel —Ñ–∞–π–ª—ã - –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª = –æ–¥–∏–Ω —Ä–µ–π—Å</p>
                </div>
                <div class="header-right">
                    <div class="user-email" id="userEmail"></div>
                    <button class="btn btn-logout" onclick="logout()">–í—ã—Ö–æ–¥</button>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('main')">üè† –ì–ª–∞–≤–Ω–∞—è</button>
                <button class="tab" onclick="switchTab('database')">üìä –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</button>
            </div>

            <div id="mainTab">
                <div class="upload-section">
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">üìÅ</div>
                        <div style="font-size: 1.3em; font-weight: 600; color: #2c3e50;">–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã</div>
                        <div style="color: #7f8c8d; margin-top: 10px;">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤ —Å—Ä–∞–∑—É</div>
                        <input type="file" id="fileInput" accept=".xlsx,.xls" multiple style="display: none;">
                    </div>
                </div>

                <div class="filters">
                    <button class="filter-btn active" onclick="setMainFilter('all')">üìã –í—Å–µ —Ä–µ–π—Å—ã</button>
                    <button class="filter-btn" onclick="setMainFilter('paid')">‚úÖ –û–ø–ª–∞—á–µ–Ω–Ω—ã–µ</button>
                    <button class="filter-btn" onclick="setMainFilter('unpaid')">‚ùå –ù–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ</button>
                    <button class="btn btn-download" onclick="printMain()" style="margin-left: auto;">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
                </div>

                <div class="orders-grid" id="ordersGrid"></div>
            </div>

            <div id="databaseTab" class="hidden">
                <div class="filters">
                    <button class="filter-btn active" onclick="setFilter('all')">üìã –í—Å–µ</button>
                    <button class="filter-btn" onclick="setFilter('paid')">‚úÖ –û–ø–ª–∞—á–µ–Ω–æ</button>
                    <button class="filter-btn" onclick="setFilter('unpaid')">‚ùå –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ</button>
                    <select id="employeeFilter" onchange="filterByEmployee()" style="padding: 10px; border-radius: 10px; font-weight: 600; border: 2px solid #667eea; margin-left: 10px;">
                        <option value="">üë§ –í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</option>
                        <option value="–ú—É—Ö–∞–º–º–∞–¥">–ú—É—Ö–∞–º–º–∞–¥</option>
                        <option value="–ñ–æ–ª–¥–æ—à">–ñ–æ–ª–¥–æ—à</option>
                        <option value="–ù–∏–∑">–ù–∏–∑</option>
                        <option value="–ò–Ω–≤–∞—Ä">–ò–Ω–≤–∞—Ä</option>
                        <option value="–§–∞—Ä—É—Ñ">–§–∞—Ä—É—Ñ</option>
                        <option value="–£–º–∏–¥">–£–º–∏–¥</option>
                        <option value="–°–∏—Ä–æ–∂">–°–∏—Ä–æ–∂</option>
                    </select>
                    <button class="btn btn-download" onclick="printDatabase()" style="margin-left: auto;">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
                </div>
                
                <div class="database-section">
                    <h2 style="margin-bottom: 20px; text-align: center; color: #2c3e50;">üìä –í—Å–µ —Ä–µ–π—Å—ã –≤ –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ</h2>
                    <div style="overflow-x: auto;">
                        <table class="database-table" id="databaseTable">
                            <thead id="databaseTableHead"></thead>
                            <tbody id="databaseTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal">
        <span class="modal-close" id="modalClose">√ó</span>
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">–†–µ–π—Å</div>
            <div style="text-align: center; margin-bottom: 20px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-download" onclick="downloadCurrentOrder()">üíæ –°–∫–∞—á–∞—Ç—å –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –≤ Excel</button>
                <button class="filter-btn active" onclick="setModalFilter('all')">üìã –í—Å–µ</button>
                <button class="filter-btn" onclick="setModalFilter('paid')">‚úÖ –û–ø–ª–∞—á–µ–Ω–æ</button>
                <button class="filter-btn" onclick="setModalFilter('unpaid')">‚ùå –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ</button>
                <button class="btn btn-download" onclick="printModal()">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
            </div>
            <div id="tableWrapper"></div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let orders = [];
        let currentOrder = null;
        let currentTab = 'main';
        let currentFilter = 'all';
        let mainFilter = 'all';
        let modalFilter = 'all';
        let employeeFilter = '';

        const ADMIN_EMAIL = '12abc202@gmail.com';
        const ADMIN_PASSWORD = 'Abu_1610';

        function init() {
            checkAuth();
        }

        function checkAuth() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainPage();
            } else {
                showLoginPage();
            }
        }

        function showLoginPage() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('mainPage').classList.add('hidden');
        }

        function showMainPage() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainPage').classList.remove('hidden');
            document.getElementById('userEmail').textContent = currentUser.email;
            loadUserOrders();
        }

        function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorMsg = document.getElementById('loginError');

            if (!email || !password) {
                errorMsg.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
                return;
            }

            if (email === ADMIN_EMAIL && password === ADMIN_PASSWORD) {
                currentUser = { email, isAdmin: true };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showMainPage();
            } else {
                errorMsg.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ';
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            orders = [];
            showLoginPage();
        }

        function loadUserOrders() {
            const savedOrders = localStorage.getItem(`orders_${currentUser.email}`);
            if (savedOrders) {
                orders = JSON.parse(savedOrders);
            } else {
                orders = [];
            }
            renderAll();
        }

        function saveUserOrders() {
            localStorage.setItem(`orders_${currentUser.email}`, JSON.stringify(orders));
        }

        function switchTab(tab) {
            currentTab = tab;
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            if (tab === 'main') {
                document.getElementById('mainTab').classList.remove('hidden');
                document.getElementById('databaseTab').classList.add('hidden');
            } else {
                document.getElementById('mainTab').classList.add('hidden');
                document.getElementById('databaseTab').classList.remove('hidden');
            }
            renderAll();
        }

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const modal = document.getElementById('modal');
        const modalClose = document.getElementById('modalClose');

        uploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFiles);

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.background = '#667eea';
            uploadArea.style.color = 'white';
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.background = '#f8f9fa';
            uploadArea.style.color = '';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.background = '#f8f9fa';
            uploadArea.style.color = '';
            handleFiles({ target: { files: e.dataTransfer.files } });
        });

        modalClose.addEventListener('click', () => modal.classList.remove('active'));
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.classList.remove('active');
        });

        function handleFiles(e) {
            const files = Array.from(e.target.files);
            
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '', raw: false });

                        const rowsWithStatus = jsonData.map((row, index) => {
                            if (index === 0) {
                                return row;
                            } else {
                                return {
                                    data: row,
                                    status: '–Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ',
                                    paymentDate: null,
                                    employee: '',
                                    rowId: index,
                                    calculated: false
                                };
                            }
                        });

                        const order = {
                            id: Date.now() + Math.random(),
                            fileName: file.name,
                            data: rowsWithStatus,
                            uploadDate: new Date().toLocaleDateString('ru-RU')
                        };

                        orders.push(order);
                        saveUserOrders();
                        renderAll();
                    } catch (error) {
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: ' + file.name);
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function deleteOrder(orderId, event) {
            if (event) {
                event.stopPropagation();
            }
            
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ä–µ–π—Å?')) {
                orders = orders.filter(o => o.id !== orderId);
                saveUserOrders();
                renderAll();
            }
        }

        function renderAll() {
            renderOrderCards();
            renderDatabase();
        }

        function renderOrderCards() {
            const grid = document.getElementById('ordersGrid');
            grid.innerHTML = '';

            orders.forEach(order => {
                const dataRows = order.data.filter((r, i) => i > 0);
                const paidCount = dataRows.filter(r => r.status === '–æ–ø–ª–∞—á–µ–Ω–æ').length;
                const unpaidCount = dataRows.length - paidCount;
                
                if (mainFilter === 'paid' && paidCount === 0) return;
                if (mainFilter === 'unpaid' && unpaidCount === 0) return;
                
                const card = document.createElement('div');
                card.className = 'order-card';
                card.innerHTML = `
                    <div class="order-card-content" onclick="showOrderDetails(orders.find(o => o.id === ${order.id}))">
                        <div class="order-icon">üì¶</div>
                        <div class="order-title">${order.fileName}</div>
                        <div class="order-info">üìÖ ${order.uploadDate}</div>
                        <div class="order-info">üìä ${dataRows.length} –∑–∞–ø–∏—Å–µ–π</div>
                        <div class="order-info" style="color: #27ae60; font-weight: 600;">‚úÖ ${paidCount}</div>
                        <div class="order-info" style="color: #e74c3c; font-weight: 600;">‚ùå ${unpaidCount}</div>
                    </div>
                    <div class="order-actions">
                        <button class="btn btn-delete" onclick="deleteOrder(${order.id}, event)">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function setMainFilter(filter) {
            mainFilter = filter;
            const btns = document.querySelectorAll('.filters .filter-btn');
            btns.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderOrderCards();
        }

        function setFilter(filter) {
            currentFilter = filter;
            const btns = document.querySelectorAll('#databaseTab .filter-btn');
            btns.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderDatabase();
        }

        function setModalFilter(filter) {
            modalFilter = filter;
            const btns = document.querySelectorAll('#modal .filter-btn');
            btns.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            showOrderDetails(currentOrder);
        }

        function filterByEmployee() {
            employeeFilter = document.getElementById('employeeFilter').value;
            renderDatabase();
        }

        function findPriceColumn(headers) {
            for (let i = 0; i < headers.length; i++) {
                const headerStr = String(headers[i]).toLowerCase();
                if (headerStr.includes('—Ü–µ–Ω–∞') || headerStr.includes('price') || headerStr.includes('0.')) {
                    return i;
                }
            }
            return -1;
        }

        function calculateSum(row, headers) {
            const priceIdx = findPriceColumn(headers);
            if (priceIdx === -1) return 0;

            let sum = 0;
            for (let i = 0; i < priceIdx; i++) {
                const headerStr = String(headers[i]).toLowerCase();
                if (!headerStr.includes('–∂–∞–º–∏') && !headerStr.includes('—Ñ–∏–æ') && !headerStr.includes('—É–∑–±')) {
                    const value = parseFloat(row.data[i]) || 0;
                    sum += value;
                }
            }

            const price = parseFloat(row.data[priceIdx]) || 0;
            return (sum * price).toFixed(2);
        }

        function renderDatabase() {
            const thead = document.getElementById('databaseTableHead');
            const tbody = document.getElementById('databaseTableBody');
            thead.innerHTML = '';
            tbody.innerHTML = '';

            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="100" style="text-align: center; padding: 40px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
                return;
            }

            let maxColumns = 0;
            let headerExample = [];
            let priceColIndex = -1;
            
            orders.forEach(order => {
                if (order.data.length > 0) {
                    const headers = order.data[0];
                    const pIdx = findPriceColumn(headers);
                    if (pIdx !== -1) priceColIndex = pIdx;
                    
                    if (headers.length > maxColumns) {
                        maxColumns = headers.length;
                        headerExample = headers;
                    }
                }
            });

            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th>–§–∞–π–ª (–†–µ–π—Å)</th>';
            headerExample.forEach((h, idx) => {
                const headerStr = String(h).toLowerCase();
                if (!headerStr.includes('–∂–∞–º–∏') && !headerStr.includes('—Ñ–∏–æ') && !headerStr.includes('—É–∑–±')) {
                    headerRow.innerHTML += `<th>${h || ''}</th>`;
                }
            });
            headerRow.innerHTML += '<th>–ñ–ê–ú–ò (–°—É–º–º–∞)</th><th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã</th>';
            thead.appendChild(headerRow);

            orders.forEach(order => {
                const dataRows = order.data.filter((r, i) => i > 0);
                const headers = order.data[0];
                
                dataRows.forEach(row => {
                    const hasData = row.data.some(cell => cell && String(cell).trim() !== '');
                    if (!hasData) return;

                    if (currentFilter === 'paid' && row.status !== '–æ–ø–ª–∞—á–µ–Ω–æ') return;
                    if (currentFilter === 'unpaid' && row.status === '–æ–ø–ª–∞—á–µ–Ω–æ') return;
                    if (employeeFilter && row.employee !== employeeFilter) return;

                    const tr = document.createElement('tr');
                    
                    tr.innerHTML = `<td style="font-weight: bold;">${order.fileName}</td>`;
                    
                    for (let i = 0; i < headers.length; i++) {
                        const headerStr = String(headers[i]).toLowerCase();
                        if (headerStr.includes('–∂–∞–º–∏') || headerStr.includes('—Ñ–∏–æ') || headerStr.includes('—É–∑–±')) {
                            continue;
                        }
                        const value = row.data[i] || '';
                        const isEditable = i !== findPriceColumn(headers);
                        if (isEditable) {
                            tr.innerHTML += `<td class="editable-cell" onclick="editCellDB('${order.id}', ${row.rowId}, ${i}, this)">${value}</td>`;
                        } else {
                            tr.innerHTML += `<td>${value}</td>`;
                        }
                    }
                    
                    const sum = calculateSum(row, headers);
                    tr.innerHTML += `<td class="sum-cell">${sum}</td>`;
                    
                    const employeeName = row.employee || '';
                    tr.innerHTML += `<td style="text-align: center; cursor: pointer; background: #e3f2fd;">
                        <select onchange="updateEmployee('${order.id}', ${row.rowId}, this.value)" style="width: 100%; padding: 5px; border-radius: 5px; border: 1px solid #667eea;">
                            <option value="">–í—ã–±—Ä–∞—Ç—å</option>
                            <option value="–ú—É—Ö–∞–º–º–∞–¥" ${employeeName === '–ú—É—Ö–∞–º–º–∞–¥' ? 'selected' : ''}>–ú—É—Ö–∞–º–º–∞–¥</option>
                            <option value="–ñ–æ–ª–¥–æ—à" ${employeeName === '–ñ–æ–ª–¥–æ—à' ? 'selected' : ''}>–ñ–æ–ª–¥–æ—à</option>
                            <option value="–ù–∏–∑" ${employeeName === '–ù–∏–∑' ? 'selected' : ''}>–ù–∏–∑</option>
                            <option value="–ò–Ω–≤–∞—Ä" ${employeeName === '–ò–Ω–≤–∞—Ä' ? 'selected' : ''}>–ò–Ω–≤–∞—Ä</option>
                            <option value="–§–∞—Ä—É—Ñ" ${employeeName === '–§–∞—Ä—É—Ñ' ? 'selected' : ''}>–§–∞—Ä—É—Ñ</option>
                            <option value="–£–º–∏–¥" ${employeeName === '–£–º–∏–¥' ? 'selected' : ''}>–£–º–∏–¥</option>
                            <option value="–°–∏—Ä–æ–∂" ${employeeName === '–°–∏—Ä–æ–∂' ? 'selected' : ''}>–°–∏—Ä–æ–∂</option>
                        </select>
                    </td>`;
                    
                    const statusClass = row.status === '–æ–ø–ª–∞—á–µ–Ω–æ' ? 'status-paid' : 'status-unpaid';
                    const statusText = row.status === '–æ–ø–ª–∞—á–µ–Ω–æ' ? '‚úÖ –û–ø–ª–∞—á–µ–Ω–æ' : '‚ùå –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ';
                    const paymentDateText = row.paymentDate || '-';
                    
                    tr.innerHTML += `
                        <td class="status-cell ${statusClass}" onclick="toggleRowStatusFromDB('${order.id}', ${row.rowId})">${statusText}</td>
                        <td style="text-align: center;">${paymentDateText}</td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        }

        window.updateEmployee = function(orderId, rowId, value) {
            const order = orders.find(o => o.id == orderId);
            if (order) {
                const row = order.data.find(r => r.rowId === rowId);
                if (row) {
                    row.employee = value;
                    saveUserOrders();
                }
            }
        }

        function showOrderDetails(order) {
            currentOrder = order;
            document.getElementById('modalTitle').textContent = order.fileName;
            
            if (order.data.length === 0) {
                document.getElementById('tableWrapper').innerHTML = '<p style="text-align: center; padding: 40px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
                modal.classList.add('active');
                return;
            }

            let tableHTML = '<table class="database-table">';
            
            const headers = order.data[0];
            const priceIdx = findPriceColumn(headers);

            order.data.forEach((row, rowIndex) => {
                if (rowIndex === 0) {
                    tableHTML += '<thead><tr>';
                    for (let i = 0; i < headers.length; i++) {
                        const headerStr = String(headers[i]).toLowerCase();
                        if (!headerStr.includes('–∂–∞–º–∏') && !headerStr.includes('—Ñ–∏–æ') && !headerStr.includes('—É–∑–±')) {
                            tableHTML += `<th>${headers[i] || ''}</th>`;
                        }
                    }
                    tableHTML += '<th>–ñ–ê–ú–ò (–°—É–º–º–∞)</th><th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã</th></tr></thead><tbody>';
                } else {
                    if (modalFilter === 'paid' && row.status !== '–æ–ø–ª–∞—á–µ–Ω–æ') return;
                    if (modalFilter === 'unpaid' && row.status === '–æ–ø–ª–∞—á–µ–Ω–æ') return;
                    
                    const rowData = row.data;
                    const hasData = rowData.some(cell => cell && String(cell).trim() !== '');
                    if (!hasData) return;
                    
                    tableHTML += '<tr>';
                    
                    for (let colIndex = 0; colIndex < headers.length; colIndex++) {
                        const headerStr = String(headers[colIndex]).toLowerCase();
                        if (headerStr.includes('–∂–∞–º–∏') || headerStr.includes('—Ñ–∏–æ') || headerStr.includes('—É–∑–±')) {
                            continue;
                        }
                        const value = rowData[colIndex] || '';
                        if (colIndex !== priceIdx) {
                            tableHTML += `<td class="editable-cell" onclick="editCell('${order.id}', ${row.rowId}, ${colIndex}, this)">${value}</td>`;
                        } else {
                            tableHTML += `<td>${value}</td>`;
                        }
                    }
                    
                    const sum = calculateSum(row, headers);
                    tableHTML += `<td class="sum-cell">${sum}</td>`;
                    
                    const employeeName = row.employee || '';
                    tableHTML += `<td style="text-align: center; background: #e3f2fd;">
                        <select onchange="updateEmployeeModal('${order.id}', ${row.rowId}, this.value)" style="width: 100%; padding: 5px; border-radius: 5px; border: 1px solid #667eea;">
                            <option value="">–í—ã–±—Ä–∞—Ç—å</option>
                            <option value="–ú—É—Ö–∞–º–º–∞–¥" ${employeeName === '–ú—É—Ö–∞–º–º–∞–¥' ? 'selected' : ''}>–ú—É—Ö–∞–º–º–∞–¥</option>
                            <option value="–ñ–æ–ª–¥–æ—à" ${employeeName === '–ñ–æ–ª–¥–æ—à' ? 'selected' : ''}>–ñ–æ–ª–¥–æ—à</option>
                            <option value="–ù–∏–∑" ${employeeName === '–ù–∏–∑' ? 'selected' : ''}>–ù–∏–∑</option>
                            <option value="–ò–Ω–≤–∞—Ä" ${employeeName === '–ò–Ω–≤–∞—Ä' ? 'selected' : ''}>–ò–Ω–≤–∞—Ä</option>
                            <option value="–§–∞—Ä—É—Ñ" ${employeeName === '–§–∞—Ä—É—Ñ' ? 'selected' : ''}>–§–∞—Ä—É—Ñ</option>
                            <option value="–£–º–∏–¥" ${employeeName === '–£–º–∏–¥' ? 'selected' : ''}>–£–º–∏–¥</option>
                            <option value="–°–∏—Ä–æ–∂" ${employeeName === '–°–∏—Ä–æ–∂' ? 'selected' : ''}>–°–∏—Ä–æ–∂</option>
                        </select>
                    </td>`;
                    
                    const statusClass = row.status === '–æ–ø–ª–∞—á–µ–Ω–æ' ? 'status-paid' : 'status-unpaid';
                    const statusText = row.status === '–æ–ø–ª–∞—á–µ–Ω–æ' ? '‚úÖ –û–ø–ª–∞—á–µ–Ω–æ' : '‚ùå –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ';
                    const paymentDateText = row.paymentDate || '-';
                    
                    tableHTML += `
                        <td class="status-cell ${statusClass}" onclick="toggleRowStatus('${order.id}', ${row.rowId})">${statusText}</td>
                        <td style="text-align: center;">${paymentDateText}</td>
                    `;
                    tableHTML += '</tr>';
                }
            });

            tableHTML += '</tbody></table>';
            document.getElementById('tableWrapper').innerHTML = tableHTML;
            modal.classList.add('active');
        }

        window.editCell = function(orderId, rowId, colIndex, cellElement) {
            const currentValue = cellElement.textContent;
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'cell-input';
            input.value = currentValue;
            
            cellElement.textContent = '';
            cellElement.appendChild(input);
            input.focus();
            input.select();
            
            function saveEdit() {
                const newValue = input.value;
                const order = orders.find(o => o.id == orderId);
                if (order) {
                    const row = order.data.find(r => r.rowId === rowId);
                    if (row) {
                        row.data[colIndex] = newValue;
                        saveUserOrders();
                        cellElement.textContent = newValue;
                        renderAll();
                    }
                }
            }
            
            input.addEventListener('blur', saveEdit);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    saveEdit();
                }
            });
        }

        window.editCellDB = function(orderId, rowId, colIndex, cellElement) {
            const currentValue = cellElement.textContent;
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'cell-input';
            input.value = currentValue;
            
            cellElement.textContent = '';
            cellElement.appendChild(input);
            input.focus();
            input.select();
            
            function saveEdit() {
                const newValue = input.value;
                const order = orders.find(o => o.id == orderId);
                if (order) {
                    const row = order.data.find(r => r.rowId === rowId);
                    if (row) {
                        row.data[colIndex] = newValue;
                        saveUserOrders();
                        cellElement.textContent = newValue;
                    }
                }
            }
            
            input.addEventListener('blur', saveEdit);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    saveEdit();
                }
            });
        }

        window.updateEmployeeModal = function(orderId, rowId, value) {
            const order = orders.find(o => o.id == orderId);
            if (order) {
                const row = order.data.find(r => r.rowId === rowId);
                if (row) {
                    row.employee = value;
                    saveUserOrders();
                    showOrderDetails(order);
                }
            }
        }

        window.toggleRowStatus = function(orderId, rowId) {
            const order = orders.find(o => o.id == orderId);
            if (order) {
                const row = order.data.find(r => r.rowId === rowId);
                if (row) {
                    if (row.status === '–æ–ø–ª–∞—á–µ–Ω–æ') {
                        row.status = '–Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ';
                        row.paymentDate = null;
                    } else {
                        row.status = '–æ–ø–ª–∞—á–µ–Ω–æ';
                        const now = new Date();
                        row.paymentDate = now.toLocaleString('ru-RU', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }
                    saveUserOrders();
                    showOrderDetails(order);
                    renderAll();
                }
            }
        }

        window.toggleRowStatusFromDB = function(orderId, rowId) {
            const order = orders.find(o => o.id == orderId);
            if (order) {
                const row = order.data.find(r => r.rowId === rowId);
                if (row) {
                    if (row.status === '–æ–ø–ª–∞—á–µ–Ω–æ') {
                        row.status = '–Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ';
                        row.paymentDate = null;
                    } else {
                        row.status = '–æ–ø–ª–∞—á–µ–Ω–æ';
                        const now = new Date();
                        row.paymentDate = now.toLocaleString('ru-RU', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }
                    saveUserOrders();
                    renderAll();
                }
            }
        }

        window.downloadCurrentOrder = function() {
            if (!currentOrder) return;
            
            const exportData = [];
            const headers = currentOrder.data[0];
            exportData.push(headers);
            
            currentOrder.data.forEach((row, index) => {
                if (index > 0 && row.status === '–Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ') {
                    const hasData = row.data.some(cell => cell && String(cell).trim() !== '');
                    if (hasData) {
                        exportData.push(row.data);
                    }
                }
            });
            
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '–ù–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ');
            
            const fileName = currentOrder.fileName.replace('.xlsx', '').replace('.xls', '') + '_–Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ.xlsx';
            XLSX.writeFile(wb, fileName);
        }

        window.printMain = function() {
            window.print();
        }

        window.printDatabase = function() {
            window.print();
        }

        window.printModal = function() {
            window.print();
        }

        init();
    </script>
</body>
</html>